@page "/"
@implements IDisposable
@inject IWeatherForecastService WeatherForecastService

@if (currentWeather == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div id="main" class="@GetBackgroundClass()">
        <div class="weather-now">
            <h1>SEATTLE</h1>
            <div class="location-img"></div>
            <div class="temperature">
                @GetTemperature(currentWeather)
                <div class="unit-switch" @onclick="SwitchTemperatureUnit">
                    <span class="temp-unit">@temperatureUnit</span>
                    <span class="temp-unit-option">/ @(temperatureUnit == "F" ? "C" : "F")</span>
                </div>
            </div>
            <div class="summary">@currentWeather.WeatherText</div>
            <div class="update-info">Updated @GetTimeToDisplay(currentWeather)</div>
            <div class="metrics">
                <div>UV index <p>@currentWeather.UVIndex</p></div>
                <div>Barometer <p>@currentWeather.Pressure</p></div>
                <div>Humidity <p>@currentWeather.RelativeHumidity%</p></div>
                <div>Wind <p>@currentWeather.WindSpeed mph @currentWeather.WindDirection</p></div>
            </div>
        </div>
        <div class="weather-graph">
            <TelerikChart Transitions="false">
                <ChartSeriesItems>
                    <ChartSeries Color="#ffff88" Type="ChartSeriesType.Line" Data="GetWeather()" Field="@nameof(WeatherResponse.Temperature)"></ChartSeries>
                </ChartSeriesItems>

                <ChartCategoryAxes>
                    <ChartCategoryAxis Color="white" Categories="chartDatapoints.Select(w => GetTimeToDisplay(w)).ToArray()"></ChartCategoryAxis>
                </ChartCategoryAxes>

                <ChartValueAxes>
                    <ChartValueAxis Color="white" >
                        <ChartValueAxisLabels Color="white" Format="@($"{0}°{temperatureUnit}")"></ChartValueAxisLabels>
                    </ChartValueAxis>
                </ChartValueAxes>

            </TelerikChart>
        </div>
    </div>
}


@code {
    WeatherResponse currentWeather;
    IList<WeatherResponse> chartDatapoints = new List<WeatherResponse>();
    string temperatureUnit = "F";

    CancellationTokenSource streamingWeatherCTS = new CancellationTokenSource();

    protected override async Task OnInitializedAsync()
    {
        currentWeather = await WeatherForecastService.GetWeather();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _ = GetWeatherUpdates();
        }
    }

    async Task GetWeatherUpdates()
    {
        await foreach (var weatherResponse in WeatherForecastService.GetStreamingWeather(streamingWeatherCTS.Token))
        {
            currentWeather = weatherResponse;
            AddChartDatapoint(weatherResponse);
            StateHasChanged();
        }
    }

    void AddChartDatapoint(WeatherResponse weatherUpdate)
    {
        chartDatapoints.Add(weatherUpdate);
        while (chartDatapoints.Count > 20)
        {
            chartDatapoints.RemoveAt(0);
        }
    }

    string GetBackgroundClass()
    {
        if (currentWeather == null)
        {
            return string.Empty;
        }
        else if (!currentWeather.IsDayTime)
        {
            return "night";
        }
        else if (currentWeather.Temperature > 60)
        {
            return "warm";
        }
        else
        {
            return "cold";
        }
    }

    void SwitchTemperatureUnit()
    {
        temperatureUnit = temperatureUnit == "F" ? "C" : "F";
    }

    float GetTemperature(WeatherResponse w)
        => temperatureUnit == "F" ? w.Temperature : TemperatureAsCelsius(w.Temperature);

    float TemperatureAsCelsius(float f)
        => (float)Math.Round((f - 23f) / 1.8f);

    string GetTimeToDisplay(WeatherResponse w)
        => w.RetrievedTime.ToDateTimeOffset().ToLocalTime().ToString("h:mm tt");

    IEnumerable<WeatherResponse> GetWeather()
        => temperatureUnit == "F"
        ? chartDatapoints
        : chartDatapoints.Select(w => new WeatherResponse { Temperature = GetTemperature(w) });

    void IDisposable.Dispose()
    {
        streamingWeatherCTS.Cancel();
    }
}
